{% extends 'base.html' %}

{% block title %}Compra {{ purchase.purchase_date }} - Financial Helper{% endblock %}

{% block page_title %}Detalle de Compra{% endblock %}

{% block header_actions %}
<a href="{% url 'purchases:list' %}" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors">
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
    </svg>
    Volver
</a>
{% endblock %}

{% block content %}
<div x-data="purchaseEditor()" class="max-w-5xl mx-auto">
    <!-- Header Card -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 sm:p-6 mb-4 sm:mb-6">
        <div class="flex flex-col gap-4">
            <!-- Establishment & Meta -->
            <div>
                <div class="flex flex-wrap items-center gap-2 mb-2">
                    <h2 class="text-lg sm:text-xl font-bold text-gray-900">{{ purchase.establishment.name|default:"Sin establecimiento" }}</h2>
                    {% if purchase.invoice_image %}
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        Imagen
                    </span>
                    {% endif %}
                </div>
                <div class="flex flex-wrap items-center gap-3 sm:gap-4 text-xs sm:text-sm text-gray-500">
                    <div class="flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <input
                            type="date"
                            x-model="purchaseDate"
                            @change="updateDate()"
                            class="text-xs sm:text-sm text-gray-500 border border-transparent hover:border-gray-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 rounded px-1 py-0.5 transition-colors bg-transparent cursor-pointer"
                        >
                    </div>
                    {% if purchase.purchase_time %}
                    <div class="flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        {{ purchase.purchase_time|time:"H:i" }}
                    </div>
                    {% endif %}
                    <div class="flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        {{ purchase.user.username }}
                    </div>
                </div>
            </div>

            <!-- Totals - Highlighted section -->
            <div class="bg-gray-50 -mx-4 sm:-mx-6 -mb-4 sm:-mb-6 px-4 sm:px-6 py-4 rounded-b-lg border-t border-gray-100">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                    <div class="text-2xl sm:text-3xl font-bold text-gray-900">
                        Bs.<span x-text="formatNumber(purchase.total_ves)">{{ purchase.total_ves|floatformat:2 }}</span>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-1.5">
                            <div class="w-2 h-2 rounded-full bg-blue-500"></div>
                            <span class="text-sm font-semibold text-blue-600">$<span x-text="formatNumber(purchase.total_usd_bcv)">{{ purchase.total_usd_bcv|floatformat:2 }}</span></span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <div class="w-2 h-2 rounded-full bg-orange-500"></div>
                            <span class="text-sm font-semibold text-orange-600">$<span x-text="formatNumber(purchase.total_usd_binance)">{{ purchase.total_usd_binance|floatformat:2 }}</span></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Status Indicator -->
    <div x-show="saveStatus" x-transition class="fixed top-4 right-4 z-50">
        <div x-show="saveStatus === 'saving'" class="bg-blue-100 text-blue-800 px-4 py-2 rounded-lg shadow-lg flex items-center gap-2">
            <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Guardando...
        </div>
        <div x-show="saveStatus === 'saved'" class="bg-green-100 text-green-800 px-4 py-2 rounded-lg shadow-lg flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            Guardado
        </div>
        <div x-show="saveStatus === 'error'" class="bg-red-100 text-red-800 px-4 py-2 rounded-lg shadow-lg flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            Error al guardar
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6">
        <!-- Items List -->
        <div class="lg:col-span-2 order-2 lg:order-1">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                    <h3 class="text-base font-semibold text-gray-900">Items ({{ purchase.items.count }})</h3>
                    <span class="text-xs text-gray-500">Click en el monto para editar</span>
                </div>
                <div class="divide-y divide-gray-200">
                    {% for item in purchase.items.all %}
                    <div class="px-4 sm:px-6 py-4 hover:bg-gray-50 transition-colors">
                        <!-- Mobile: Stack layout / Desktop: Row layout -->
                        <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3 sm:gap-4">
                            <!-- Product Info -->
                            <div class="flex-1 min-w-0">
                                <div class="flex flex-wrap items-center gap-2">
                                    <h4 class="text-sm font-medium text-gray-900">{{ item.description }}</h4>
                                    {% if item.product %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800 whitespace-nowrap">
                                        {{ item.product.name }}
                                    </span>
                                    {% endif %}
                                </div>
                                <div class="flex items-center gap-3 mt-1 text-xs text-gray-500">
                                    <span>{{ item.quantity|floatformat:2 }} {{ item.unit_type|default:"unidad" }}</span>
                                    <span x-show="items['{{ item.id }}']">@ Bs.<span x-text="formatNumber(items['{{ item.id }}']?.total_ves / {{ item.quantity }})"></span>/u</span>
                                </div>
                            </div>

                            <!-- Price Section - Full width on mobile, stacked on desktop -->
                            <div class="flex items-center justify-between sm:block bg-gray-50 sm:bg-transparent -mx-4 sm:mx-0 px-4 sm:px-0 py-3 sm:py-0 border-t sm:border-0 border-gray-100 sm:text-right sm:flex-shrink-0">
                                <!-- Editable VES amount -->
                                <div class="flex items-center gap-1 sm:justify-end">
                                    <span class="text-sm text-gray-500">Bs.</span>
                                    <input
                                        type="number"
                                        inputmode="decimal"
                                        step="0.01"
                                        x-model.number="items['{{ item.id }}'].total_ves"
                                        @change="updateItem('{{ item.id }}')"
                                        @focus="$el.select()"
                                        class="w-28 sm:w-24 text-base sm:text-sm font-semibold text-gray-900 text-right border border-gray-300 sm:border-transparent hover:border-gray-300 focus:border-blue-500 focus:ring-2 sm:focus:ring-1 focus:ring-blue-500 rounded-lg sm:rounded px-3 sm:px-2 py-2 sm:py-0.5 transition-colors bg-white"
                                    >
                                </div>
                                <!-- USD values - below VES on desktop -->
                                <div class="flex flex-col sm:flex-row items-end sm:items-center sm:justify-end gap-1 sm:gap-2 sm:mt-0.5">
                                    <span class="text-xs text-blue-600 font-medium">$<span x-text="formatNumber(items['{{ item.id }}']?.total_usd_bcv)">{{ item.total_usd_bcv|floatformat:2 }}</span></span>
                                    <span class="text-xs text-orange-600 font-medium">$<span x-text="formatNumber(items['{{ item.id }}']?.total_usd_binance)">{{ item.total_usd_binance|floatformat:2 }}</span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="px-6 py-12 text-center">
                        <p class="text-sm text-gray-500">No hay items en esta compra</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Sidebar Info -->
        <div class="space-y-4 sm:space-y-6 order-1 lg:order-2">
            <!-- Mobile: Rates and Summary in a row / Desktop: Stacked -->
            <div class="grid grid-cols-2 lg:grid-cols-1 gap-4">
                <!-- Exchange Rates Used -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 sm:p-4">
                    <div class="flex items-center justify-between mb-2 sm:mb-3">
                        <h3 class="text-xs sm:text-sm font-semibold text-gray-900">Tasas</h3>
                        <span class="text-xs text-gray-400 hidden sm:inline">Editable</span>
                    </div>
                    <div class="space-y-2 sm:space-y-3">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-1 sm:gap-2">
                            <div class="flex items-center gap-2">
                                <div class="w-2 h-2 sm:w-2.5 sm:h-2.5 rounded-full bg-blue-500"></div>
                                <span class="text-xs sm:text-sm text-gray-600">BCV</span>
                            </div>
                            <div class="flex items-center gap-1">
                                <span class="text-xs sm:text-sm text-gray-500">Bs.</span>
                                <input
                                    type="number"
                                    inputmode="decimal"
                                    step="0.01"
                                    x-model.number="bcvRate"
                                    @change="updateRate('bcv')"
                                    @focus="$el.select()"
                                    class="w-full sm:w-24 text-sm font-semibold text-gray-900 text-right border border-gray-200 hover:border-gray-300 focus:border-blue-500 focus:ring-2 sm:focus:ring-1 focus:ring-blue-500 rounded-lg sm:rounded px-2 py-1.5 sm:py-0.5 transition-colors bg-white"
                                >
                            </div>
                        </div>
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-1 sm:gap-2">
                            <div class="flex items-center gap-2">
                                <div class="w-2 h-2 sm:w-2.5 sm:h-2.5 rounded-full bg-orange-500"></div>
                                <span class="text-xs sm:text-sm text-gray-600">Binance</span>
                            </div>
                            <div class="flex items-center gap-1">
                                <span class="text-xs sm:text-sm text-gray-500">Bs.</span>
                                <input
                                    type="number"
                                    inputmode="decimal"
                                    step="0.01"
                                    x-model.number="binanceRate"
                                    @change="updateRate('binance')"
                                    @focus="$el.select()"
                                    class="w-full sm:w-24 text-sm font-semibold text-gray-900 text-right border border-gray-200 hover:border-gray-300 focus:border-orange-500 focus:ring-2 sm:focus:ring-1 focus:ring-orange-500 rounded-lg sm:rounded px-2 py-1.5 sm:py-0.5 transition-colors bg-white"
                                >
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Summary -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 sm:p-4">
                    <h3 class="text-xs sm:text-sm font-semibold text-gray-900 mb-2 sm:mb-3">Resumen</h3>
                    <div class="space-y-1.5 sm:space-y-2 text-xs sm:text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Subtotal</span>
                            <span class="font-medium">Bs.<span x-text="formatNumber(purchase.subtotal_ves)">{{ purchase.subtotal_ves|floatformat:2 }}</span></span>
                        </div>
                        {% if purchase.tax_ves %}
                        <div class="flex justify-between">
                            <span class="text-gray-600">{{ purchase.tax_type|default:"IVA" }}</span>
                            <span class="font-medium">Bs.{{ purchase.tax_ves|floatformat:2 }}</span>
                        </div>
                        {% endif %}
                        <div class="border-t border-gray-200 pt-1.5 sm:pt-2 mt-1.5 sm:mt-2">
                            <div class="flex justify-between">
                                <span class="font-semibold text-gray-900">Total</span>
                                <span class="font-bold text-gray-900">Bs.<span x-text="formatNumber(purchase.total_ves)">{{ purchase.total_ves|floatformat:2 }}</span></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Invoice Image - Collapsible on mobile -->
            {% if purchase.invoice_image %}
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4" x-data="{ showImage: false }">
                <button @click="showImage = !showImage" class="w-full flex items-center justify-between sm:hidden mb-2">
                    <h3 class="text-sm font-semibold text-gray-900">Imagen de Factura</h3>
                    <svg class="w-5 h-5 text-gray-400 transition-transform" :class="{ 'rotate-180': showImage }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
                <h3 class="text-sm font-semibold text-gray-900 mb-3 hidden sm:block">Imagen de Factura</h3>
                <div class="sm:block" :class="{ 'hidden': !showImage }" x-cloak>
                    <a href="{{ purchase.invoice_image.url }}" target="_blank" class="block">
                        <img
                            src="{{ purchase.invoice_image.url }}"
                            alt="Factura"
                            class="w-full rounded-lg border border-gray-200 hover:opacity-90 transition-opacity"
                        >
                    </a>
                    <p class="text-xs text-gray-500 mt-2 text-center">Click para ver en tamano completo</p>
                </div>
            </div>
            {% endif %}

            <!-- Notes -->
            {% if purchase.notes %}
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                <h3 class="text-sm font-semibold text-gray-900 mb-2">Notas</h3>
                <p class="text-sm text-gray-600">{{ purchase.notes }}</p>
            </div>
            {% endif %}

            <!-- Metadata - Hidden on mobile, shown on desktop -->
            <div class="bg-gray-50 rounded-lg border border-gray-200 p-4 hidden lg:block">
                <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Metadata</h3>
                <div class="space-y-1 text-xs text-gray-500">
                    <div>ID: {{ purchase.id }}</div>
                    <div>Creado: {{ purchase.created_at|date:"d/m/Y H:i" }}</div>
                    <div>Actualizado: {{ purchase.updated_at|date:"d/m/Y H:i" }}</div>
                </div>
            </div>

            <!-- Delete Action -->
            <div class="bg-white rounded-lg shadow-sm border border-red-200 p-4">
                <h3 class="text-sm font-semibold text-red-700 mb-2">Zona de Peligro</h3>
                <p class="text-xs text-gray-600 mb-3 hidden sm:block">Esta accion eliminara la compra y todos sus items permanentemente.</p>
                <button
                    @click="confirmDelete()"
                    class="w-full inline-flex items-center justify-center gap-2 px-4 py-2.5 sm:py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 active:bg-red-800 rounded-lg transition-colors"
                >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    Eliminar Compra
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div x-show="showDeleteModal" x-transition class="fixed inset-0 z-50 overflow-y-auto" style="display: none;">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:p-0">
            <div x-show="showDeleteModal" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="showDeleteModal = false"></div>

            <div x-show="showDeleteModal" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" class="relative inline-block bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                            <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Eliminar compra</h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500">
                                    Estas seguro de que deseas eliminar esta compra? Se eliminaran <strong>{{ purchase.items.count }} items</strong> asociados. Esta accion no se puede deshacer.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse gap-2">
                    <button
                        @click="deletePurchase()"
                        :disabled="isDeleting"
                        class="w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:w-auto sm:text-sm disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        <span x-show="!isDeleting">Eliminar</span>
                        <span x-show="isDeleting" class="flex items-center gap-2">
                            <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Eliminando...
                        </span>
                    </button>
                    <button
                        @click="showDeleteModal = false"
                        :disabled="isDeleting"
                        class="mt-3 w-full inline-flex justify-center rounded-lg border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 sm:mt-0 sm:w-auto sm:text-sm disabled:opacity-50"
                    >
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function purchaseEditor() {
    return {
        purchaseId: '{{ purchase.id }}',
        bcvRate: {{ purchase.bcv_rate|default:"0" }},
        binanceRate: {{ purchase.binance_rate|default:"0" }},
        purchaseDate: '{{ purchase.purchase_date|date:"Y-m-d" }}',
        saveStatus: null,
        saveTimeout: null,
        showDeleteModal: false,
        isDeleting: false,

        purchase: {
            subtotal_ves: {{ purchase.subtotal_ves|default:"0" }},
            total_ves: {{ purchase.total_ves|default:"0" }},
            total_usd_bcv: {{ purchase.total_usd_bcv|default:"0" }},
            total_usd_binance: {{ purchase.total_usd_binance|default:"0" }},
        },

        items: {
            {% for item in purchase.items.all %}
            '{{ item.id }}': {
                total_ves: {{ item.total_ves|default:"0" }},
                total_usd_bcv: {{ item.total_usd_bcv|default:"0" }},
                total_usd_binance: {{ item.total_usd_binance|default:"0" }},
            },
            {% endfor %}
        },

        formatNumber(value) {
            if (value === null || value === undefined || isNaN(value)) return '0.00';
            return parseFloat(value).toFixed(2);
        },

        showStatus(status) {
            this.saveStatus = status;
            if (this.saveTimeout) clearTimeout(this.saveTimeout);
            if (status !== 'saving') {
                this.saveTimeout = setTimeout(() => {
                    this.saveStatus = null;
                }, 2000);
            }
        },

        async updateItem(itemId) {
            this.showStatus('saving');

            const item = this.items[itemId];
            if (!item) return;

            try {
                const response = await fetch(`/purchases/${this.purchaseId}/items/${itemId}/update/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        total_ves: item.total_ves
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Update item values
                    this.items[itemId] = {
                        total_ves: data.item.total_ves,
                        total_usd_bcv: data.item.total_usd_bcv,
                        total_usd_binance: data.item.total_usd_binance,
                    };

                    // Update purchase totals
                    this.purchase.subtotal_ves = data.purchase.subtotal_ves;
                    this.purchase.total_ves = data.purchase.total_ves;
                    this.purchase.total_usd_bcv = data.purchase.total_usd_bcv;
                    this.purchase.total_usd_binance = data.purchase.total_usd_binance;

                    this.showStatus('saved');
                } else {
                    console.error('Error updating item:', data.error);
                    this.showStatus('error');
                }
            } catch (error) {
                console.error('Error updating item:', error);
                this.showStatus('error');
            }
        },

        async updateRate(rateType) {
            this.showStatus('saving');

            const payload = {};
            if (rateType === 'bcv') {
                payload.bcv_rate = this.bcvRate;
            } else if (rateType === 'binance') {
                payload.binance_rate = this.binanceRate;
            }

            try {
                const response = await fetch(`/purchases/${this.purchaseId}/update-rates/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.success) {
                    // Update rates
                    this.bcvRate = data.purchase.bcv_rate;
                    this.binanceRate = data.purchase.binance_rate;

                    // Update purchase totals
                    this.purchase.total_usd_bcv = data.purchase.total_usd_bcv;
                    this.purchase.total_usd_binance = data.purchase.total_usd_binance;

                    // Update all items
                    for (const [itemId, itemData] of Object.entries(data.items)) {
                        this.items[itemId] = {
                            total_ves: itemData.total_ves,
                            total_usd_bcv: itemData.total_usd_bcv,
                            total_usd_binance: itemData.total_usd_binance,
                        };
                    }

                    this.showStatus('saved');
                } else {
                    console.error('Error updating rate:', data.error);
                    this.showStatus('error');
                }
            } catch (error) {
                console.error('Error updating rate:', error);
                this.showStatus('error');
            }
        },

        async updateDate() {
            this.showStatus('saving');

            try {
                const response = await fetch(`/purchases/${this.purchaseId}/update-date/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        purchase_date: this.purchaseDate
                    })
                });

                const data = await response.json();

                if (data.success) {
                    this.purchaseDate = data.purchase.purchase_date;
                    this.showStatus('saved');
                } else {
                    console.error('Error updating date:', data.error);
                    this.showStatus('error');
                }
            } catch (error) {
                console.error('Error updating date:', error);
                this.showStatus('error');
            }
        },

        confirmDelete() {
            this.showDeleteModal = true;
        },

        async deletePurchase() {
            this.isDeleting = true;

            try {
                const response = await fetch(`/purchases/${this.purchaseId}/delete/`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();

                if (data.success) {
                    // Redirigir al listado de compras
                    window.location.href = '/purchases/';
                } else {
                    console.error('Error deleting purchase:', data.error);
                    this.isDeleting = false;
                    this.showDeleteModal = false;
                    this.showStatus('error');
                }
            } catch (error) {
                console.error('Error deleting purchase:', error);
                this.isDeleting = false;
                this.showDeleteModal = false;
                this.showStatus('error');
            }
        }
    };
}
</script>
{% endblock %}
