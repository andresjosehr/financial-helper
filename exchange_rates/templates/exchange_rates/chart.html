{% extends 'base.html' %}

{% block title %}Tasas de Cambio VES/USD - Financial Helper{% endblock %}

{% block page_title %}Tasas de Cambio{% endblock %}

{% block extra_head %}
<!-- TradingView Lightweight Charts -->
<script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
<style>
    .card {
        transition: all 0.2s ease;
    }
    .card:hover {
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
    }
</style>
{% endblock %}

{% block header_actions %}
<div class="text-right text-xs text-gray-500" x-data x-show="$store.chart?.lastBinanceDate">
    <div>Última actualización:</div>
    <div class="mt-0.5 font-medium" x-text="$store.chart?.formatDateTime($store.chart?.lastBinanceDate)"></div>
</div>
{% endblock %}

{% block content %}
<div x-data="chartApp()">
    <!-- Metrics Grid -->
    <div x-show="stats.bcv && stats.binance" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">

        <!-- BCV Rate -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 card">
            <div class="flex items-center justify-between mb-3">
                <span class="text-xs font-semibold text-gray-500 uppercase tracking-wide">BCV Oficial</span>
                <div class="w-2 h-2 rounded-full bg-blue-500"></div>
            </div>
            <div class="text-3xl font-bold text-gray-900 mb-1" x-text="formatRate(stats.bcv?.current)"></div>
            <div class="text-xs text-gray-500">Bs/USD</div>
        </div>

        <!-- Binance Rate -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 card">
            <div class="flex items-center justify-between mb-3">
                <span class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Binance P2P</span>
                <div class="w-2 h-2 rounded-full bg-orange-500"></div>
            </div>
            <div class="text-3xl font-bold text-gray-900 mb-1" x-text="formatRate(stats.binance?.current)"></div>
            <div class="text-xs text-gray-500">Bs/USD</div>
        </div>

        <!-- Calculator Quick -->
        <div class="bg-gradient-to-br from-emerald-600 to-teal-600 rounded-lg shadow-sm p-4 card text-white">
            <div class="text-xs font-semibold uppercase tracking-wide mb-3 opacity-90">Calculadora Bidireccional</div>
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="text-[10px] opacity-75 mb-1 block uppercase tracking-wide">BCV</label>
                    <input type="number" x-model="bcvAmount" @input="calculateFromBcv()" placeholder="100"
                        class="w-full px-3 py-1.5 bg-white/20 border border-white/30 rounded text-sm font-semibold text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50">
                </div>
                <div>
                    <label class="text-[10px] opacity-75 mb-1 block uppercase tracking-wide">Binance</label>
                    <input type="number" x-model="binanceAmount" @input="calculateFromBinance()" placeholder="100"
                        class="w-full px-3 py-1.5 bg-white/20 border border-white/30 rounded text-sm font-semibold text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50">
                </div>
            </div>
            <div class="text-[10px] opacity-75 mt-2 text-center">USD equivalentes según tasas actuales</div>
        </div>
    </div>

    <!-- Spread Stats (Indicador Visual) -->
    <div x-show="stats.spreadStats" class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
        <div class="mb-6">
            <h3 class="text-sm font-bold text-gray-900">Indicador de Spread Actual</h3>
            <p class="text-xs text-gray-500 mt-1">Spread actual comparado con bandas históricas (excluyendo datos de hoy).</p>
        </div>

        <div class="relative px-2">
            <div class="relative h-8 mb-0.5">
                <div class="absolute bottom-0 transform -translate-x-1/2 z-30"
                    :style="'left: ' + Math.min(100, Math.max(0, ((stats.spreadPercent - (stats.spreadStats?.min || 0)) / ((stats.spreadStats?.max || 100) - (stats.spreadStats?.min || 0))) * 100)) + '%'">
                    <div class="text-center">
                        <div class="text-xs font-bold text-indigo-700 leading-none mb-0.5" x-text="formatPercentage(stats.spreadPercent)"></div>
                        <div class="text-[8px] font-bold uppercase px-1 py-px rounded-full inline-block leading-none"
                            :class="{
                                'bg-green-100 text-green-700': getSpreadIndicator() === 'high',
                                'bg-amber-100 text-amber-700': getSpreadIndicator() === 'medium',
                                'bg-red-100 text-red-700': getSpreadIndicator() === 'low'
                            }"
                            x-text="getSpreadIndicator() === 'high' ? 'EXCELENTE' : getSpreadIndicator() === 'medium' ? 'BUENO' : 'BAJO'">
                        </div>
                    </div>
                    <div class="w-px h-3 bg-indigo-600 mx-auto mt-0.5"></div>
                </div>

                <div x-show="stats.spreadStats?.avg" class="absolute bottom-0 transform -translate-x-1/2 z-20"
                    :style="'left: ' + Math.min(100, Math.max(0, ((stats.spreadStats?.avg - (stats.spreadStats?.min || 0)) / ((stats.spreadStats?.max || 100) - (stats.spreadStats?.min || 0))) * 100)) + '%'">
                    <div class="text-center">
                        <div class="text-xs font-bold text-amber-600 leading-none mb-0.5" x-text="formatPercentage(stats.spreadStats?.avg)"></div>
                        <div class="text-[8px] font-medium uppercase px-1 py-px bg-amber-50 text-amber-700 rounded-full inline-block leading-none">PROMEDIO</div>
                    </div>
                    <div class="w-px h-3 bg-amber-500 mx-auto mt-0.5"></div>
                </div>
            </div>

            <div class="relative h-3 bg-gradient-to-r from-red-500 via-amber-500 via-lime-500 to-green-500 rounded-full shadow-sm">
                <div class="absolute transform -translate-x-1/2 -translate-y-[3px] z-20"
                    :style="'left: ' + Math.min(100, Math.max(0, ((stats.spreadPercent - (stats.spreadStats?.min || 0)) / ((stats.spreadStats?.max || 100) - (stats.spreadStats?.min || 0))) * 100)) + '%'">
                    <div class="absolute inset-0 w-5 h-5 bg-indigo-400 rounded-full opacity-30 animate-ping"></div>
                    <div class="relative w-5 h-5 bg-gradient-to-br from-indigo-500 to-indigo-700 rounded-full shadow-lg border-2 border-white"></div>
                </div>
            </div>

            <div class="relative h-10 mt-3">
                <div class="absolute transform -translate-x-1/2" style="left: 0%">
                    <div class="w-px h-4 bg-red-400 mx-auto"></div>
                    <div class="text-center mt-1 min-w-max">
                        <div class="text-xs font-bold text-red-600" x-text="formatPercentage(stats.spreadStats?.min)"></div>
                        <div class="text-[10px] font-medium text-gray-400 uppercase">Bajo</div>
                    </div>
                </div>
                <div class="absolute transform -translate-x-1/2" :style="'left: ' + ((stats.spreadStats?.avg - stats.spreadStats?.min) / (stats.spreadStats?.max - stats.spreadStats?.min) * 100) + '%'">
                    <div class="w-px h-4 bg-amber-400 mx-auto"></div>
                    <div class="text-center mt-1 min-w-max">
                        <div class="text-xs font-bold text-amber-600" x-text="formatPercentage(stats.spreadStats?.avg)"></div>
                        <div class="text-[10px] font-medium text-gray-400 uppercase">Bueno</div>
                    </div>
                </div>
                <div class="absolute transform -translate-x-1/2" :style="'left: ' + ((stats.spreadStats?.p75 - stats.spreadStats?.min) / (stats.spreadStats?.max - stats.spreadStats?.min) * 100) + '%'">
                    <div class="w-px h-4 bg-lime-400 mx-auto"></div>
                    <div class="text-center mt-1 min-w-max">
                        <div class="text-xs font-bold text-lime-600" x-text="formatPercentage(stats.spreadStats?.p75)"></div>
                        <div class="text-[10px] font-medium text-gray-400 uppercase">Excelente</div>
                    </div>
                </div>
                <div class="absolute transform -translate-x-1/2" style="left: 100%">
                    <div class="w-px h-4 bg-green-400 mx-auto"></div>
                    <div class="text-center mt-1 min-w-max">
                        <div class="text-xs font-bold text-green-600" x-text="formatPercentage(stats.spreadStats?.max)"></div>
                        <div class="text-[10px] font-medium text-gray-400 uppercase">Máximo</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

        <!-- Chart 1: Spread Porcentual -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 lg:col-span-2">
            <div class="px-5 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-base font-bold text-gray-900">Spread Porcentual</h2>
                    <div class="flex items-center gap-3 text-xs font-medium">
                        <div class="flex items-center gap-1.5"><div class="w-3 h-0.5 bg-purple-600 rounded-full"></div><span class="text-gray-600">Spread %</span></div>
                        <div class="flex items-center gap-1.5"><div class="w-3 h-0.5 bg-amber-500 rounded-full"></div><span class="text-gray-600">Media</span></div>
                        <div class="flex items-center gap-1.5"><div class="w-3 h-0.5 bg-emerald-600 rounded-full"></div><span class="text-gray-600">P75</span></div>
                    </div>
                </div>
                <p class="text-xs text-gray-500">Spread porcentual entre Binance y BCV con bandas estadísticas históricas.</p>
            </div>
            <div class="p-5">
                <div x-show="loading" class="flex justify-center items-center" style="height: 400px;">
                    <div class="w-10 h-10 border-4 border-gray-200 border-t-indigo-600 rounded-full animate-spin"></div>
                </div>
                <div x-show="!loading && !error" class="relative">
                    <div id="spreadDualChart" class="w-full" style="height: 400px;"></div>
                    <div id="spreadDualTooltip" class="absolute bg-black text-white p-2 rounded shadow-lg pointer-events-none opacity-0 transition-opacity duration-200 z-50 text-sm"></div>
                </div>
            </div>
        </div>

        <!-- Chart 2: Tasa BCV -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="px-5 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-base font-bold text-gray-900">Tasa BCV Oficial</h2>
                    <div class="flex items-center gap-1.5 text-xs font-medium"><div class="w-3 h-0.5 bg-blue-600 rounded-full"></div><span class="text-gray-600">BCV</span></div>
                </div>
                <p class="text-xs text-gray-500">Evolución de la tasa oficial del Banco Central de Venezuela.</p>
            </div>
            <div class="p-5">
                <div x-show="loading" class="flex justify-center items-center" style="height: 320px;">
                    <div class="w-10 h-10 border-4 border-gray-200 border-t-indigo-600 rounded-full animate-spin"></div>
                </div>
                <div x-show="!loading && !error"><div id="bcvRateChart" class="w-full" style="height: 320px;"></div></div>
            </div>
        </div>

        <!-- Chart 3: Tasa Binance -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="px-5 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-base font-bold text-gray-900">Tasa Binance P2P</h2>
                    <div class="flex items-center gap-1.5 text-xs font-medium"><div class="w-3 h-0.5 bg-orange-600 rounded-full"></div><span class="text-gray-600">Binance</span></div>
                </div>
                <p class="text-xs text-gray-500">Evolución de la tasa promedio en Binance P2P.</p>
            </div>
            <div class="p-5">
                <div x-show="loading" class="flex justify-center items-center" style="height: 320px;">
                    <div class="w-10 h-10 border-4 border-gray-200 border-t-indigo-600 rounded-full animate-spin"></div>
                </div>
                <div x-show="!loading && !error" class="relative">
                    <div id="binanceRateChart" class="w-full" style="height: 320px;"></div>
                    <div id="binanceTooltip" class="absolute bg-black text-white p-2 rounded shadow-lg pointer-events-none opacity-0 transition-opacity duration-200 z-50 text-sm"></div>
                </div>
            </div>
        </div>

        <!-- Chart 4: Volatilidad -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="px-5 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-base font-bold text-gray-900">Cambios Diarios</h2>
                    <div class="flex items-center gap-3 text-xs font-medium">
                        <div class="flex items-center gap-1.5"><div class="w-2 h-2 rounded-full bg-emerald-600"></div><span class="text-gray-600">Aumentos</span></div>
                        <div class="flex items-center gap-1.5"><div class="w-2 h-2 rounded-full bg-red-600"></div><span class="text-gray-600">Disminuciones</span></div>
                    </div>
                </div>
                <p class="text-xs text-gray-500">Variación porcentual día a día de Binance.</p>
            </div>
            <div class="p-5">
                <div x-show="loading" class="flex justify-center items-center" style="height: 320px;">
                    <div class="w-10 h-10 border-4 border-gray-200 border-t-indigo-600 rounded-full animate-spin"></div>
                </div>
                <div x-show="!loading && !error"><div id="volatilityChart" class="w-full" style="height: 320px;"></div></div>
            </div>
        </div>

        <!-- Chart 5: Distribución -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="px-5 py-4 border-b border-gray-200">
                <h2 class="text-base font-bold text-gray-900 mb-2">Distribución del Spread</h2>
                <p class="text-xs text-gray-500">Histograma de frecuencias del spread %.</p>
            </div>
            <div class="p-5">
                <div x-show="loading" class="flex justify-center items-center" style="height: 320px;">
                    <div class="w-10 h-10 border-4 border-gray-200 border-t-indigo-600 rounded-full animate-spin"></div>
                </div>
                <div x-show="!loading && !error"><div id="distributionChart" class="w-full" style="height: 320px;"></div></div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function chartApp() {
    return {
        days: 30,
        endDate: new Date().toISOString().split('T')[0],
        loading: false,
        error: null,
        charts: { bcvRate: null, binanceRate: null, spreadDual: null, volatility: null, distribution: null },
        stats: { bcv: null, binance: null, spread: null, spreadPercent: null, spreadStats: null },
        bcvAmount: 100,
        binanceAmount: 0,
        lastBinanceDate: null,

        init() {
            this.fetchData();
            setInterval(() => this.fetchData(), 300000);
        },

        calculateFromBcv() {
            if (!this.stats.bcv || !this.stats.binance || !this.bcvAmount) { this.binanceAmount = ''; return; }
            const bsTotal = parseFloat(this.bcvAmount) * this.stats.bcv.current;
            this.binanceAmount = (bsTotal / this.stats.binance.current).toFixed(2);
        },

        calculateFromBinance() {
            if (!this.stats.bcv || !this.stats.binance || !this.binanceAmount) { this.bcvAmount = ''; return; }
            const bsTotal = parseFloat(this.binanceAmount) * this.stats.binance.current;
            this.bcvAmount = (bsTotal / this.stats.bcv.current).toFixed(2);
        },

        async fetchData() {
            this.loading = true;
            try {
                const response = await fetch(`/api/exchange-rates/bcv/?days=${this.days}&end_date=${this.endDate}`);
                if (!response.ok) throw new Error('Error al cargar los datos');
                const data = await response.json();
                if (data.bcv.length === 0 && data.binance_sell.length === 0) { this.error = 'No hay datos'; this.loading = false; return; }
                this.calculateStats(data.bcv, data.binance_sell, data.bands);
                this.lastBinanceDate = data.binance_sell.length > 0 ? data.binance_sell[data.binance_sell.length - 1].timestamp : null;
                this.calculateFromBcv();
                this.renderAllCharts(data.bcv, data.binance_sell);
            } catch (err) { this.error = err.message; } finally { this.loading = false; }
        },

        calculateStats(bcvRates, binanceRates, bands) {
            if (bcvRates.length > 0) {
                const vals = bcvRates.map(r => r.rate);
                this.stats.bcv = { current: vals[vals.length - 1], max: Math.max(...vals), min: Math.min(...vals) };
            }
            if (binanceRates.length > 0) {
                const vals = binanceRates.map(r => r.rate);
                this.stats.binance = { current: vals[vals.length - 1], max: Math.max(...vals), min: Math.min(...vals) };
            }
            if (this.stats.bcv && this.stats.binance) {
                this.stats.spread = this.stats.binance.current - this.stats.bcv.current;
                this.stats.spreadPercent = (this.stats.spread / this.stats.binance.current) * 100;
            }
            if (bands) this.stats.spreadStats = { min: bands.min, avg: bands.avg, p75: bands.p75, max: bands.max };
        },

        fillBcvGaps(bcvRates, binanceRates) {
            if (bcvRates.length === 0) return [];
            if (binanceRates.length === 0) return bcvRates.map(r => ({ timestamp: r.date + 'T00:00:00Z', rate: r.rate }));
            const bcvMap = new Map();
            bcvRates.forEach(r => { const rate = parseFloat(r.rate); if (!isNaN(rate)) bcvMap.set(r.date, rate); });
            const filled = [];
            let lastVal = null;
            binanceRates.forEach(r => {
                const date = r.timestamp.split('T')[0];
                const bcvVal = bcvMap.get(date);
                if (bcvVal !== undefined) lastVal = bcvVal;
                if (lastVal !== null) filled.push({ timestamp: r.timestamp, rate: lastVal });
            });
            return filled;
        },

        renderAllCharts(bcvRates, binanceRates) {
            if (typeof LightweightCharts === 'undefined') { this.error = 'Error de gráficos'; return; }
            const bcvFilled = this.fillBcvGaps(bcvRates, binanceRates);
            Object.values(this.charts).forEach(c => { if (c) c.remove(); });
            this.renderBcvRateChart(bcvFilled, binanceRates);
            this.renderBinanceRateChart(bcvFilled, binanceRates);
            this.renderSpreadDualChart(bcvFilled, binanceRates);
            this.renderVolatilityChart(bcvFilled, binanceRates);
            this.renderDistributionChart(bcvFilled, binanceRates);
        },

        renderBcvRateChart(bcvFilled) {
            const container = document.getElementById('bcvRateChart');
            if (!container || bcvFilled.length === 0) return;
            this.charts.bcvRate = LightweightCharts.createChart(container, {
                width: container.clientWidth, height: 320,
                layout: { background: { color: '#fff' }, textColor: '#333' },
                grid: { vertLines: { color: '#f0f0f0' }, horzLines: { color: '#f0f0f0' } },
                timeScale: { borderColor: '#ccc', timeVisible: true, secondsVisible: false },
                rightPriceScale: { borderColor: '#ccc', scaleMargins: { top: 0.1, bottom: 0.1 } },
            });
            const data = this.prepareTimeSeriesData(bcvFilled, 'timestamp');
            const series = this.charts.bcvRate.addAreaSeries({ topColor: 'rgba(37,99,235,0.3)', bottomColor: 'rgba(37,99,235,0.05)', lineColor: '#2563eb', lineWidth: 2.5 });
            series.setData(data);
            if (data.length > 0) {
                setTimeout(() => {
                    const last = data[data.length - 1];
                    this.charts.bcvRate.timeScale().setVisibleRange({ from: last.time - 7*24*60*60, to: last.time + 3600 });
                }, 100);
            }
            this.makeResponsive(container, this.charts.bcvRate);
        },

        renderBinanceRateChart(bcvFilled, binanceRates) {
            const container = document.getElementById('binanceRateChart');
            if (!container || binanceRates.length === 0) return;
            this.charts.binanceRate = LightweightCharts.createChart(container, {
                width: container.clientWidth, height: 320,
                layout: { background: { color: '#fff' }, textColor: '#333' },
                grid: { vertLines: { color: '#f0f0f0' }, horzLines: { color: '#f0f0f0' } },
                timeScale: { borderColor: '#ccc', timeVisible: true, secondsVisible: false },
                rightPriceScale: { borderColor: '#ccc', scaleMargins: { top: 0.1, bottom: 0.1 } },
            });
            const data = this.prepareTimeSeriesData(binanceRates, 'timestamp');
            const series = this.charts.binanceRate.addAreaSeries({ topColor: 'rgba(249,115,22,0.3)', bottomColor: 'rgba(249,115,22,0.05)', lineColor: '#f97316', lineWidth: 2.5 });
            series.setData(data);
            if (data.length > 0) {
                setTimeout(() => {
                    const last = data[data.length - 1];
                    this.charts.binanceRate.timeScale().setVisibleRange({ from: last.time - 24*60*60, to: last.time + 3600 });
                }, 100);
            }
            this.makeResponsive(container, this.charts.binanceRate);
        },

        renderSpreadDualChart(bcvFilled, binanceRates) {
            const container = document.getElementById('spreadDualChart');
            if (!container || bcvFilled.length === 0 || binanceRates.length === 0) return;
            this.charts.spreadDual = LightweightCharts.createChart(container, {
                width: container.clientWidth, height: 400,
                layout: { background: { color: '#fff' }, textColor: '#333' },
                grid: { vertLines: { color: '#f0f0f0' }, horzLines: { color: '#f0f0f0' } },
                timeScale: { borderColor: '#ccc', timeVisible: true, secondsVisible: false },
                rightPriceScale: { borderColor: '#9333ea', scaleMargins: { top: 0.1, bottom: 0.1 } },
            });
            const bcvMap = new Map(bcvFilled.map(r => [r.timestamp, parseFloat(r.rate)]));
            const spreadData = [];
            binanceRates.forEach(r => {
                const bRate = parseFloat(r.rate), cRate = bcvMap.get(r.timestamp);
                if (!cRate || !bRate) return;
                spreadData.push({ time: Math.floor(new Date(r.timestamp).getTime() / 1000), value: ((bRate - cRate) / bRate) * 100 });
            });
            const line = this.charts.spreadDual.addLineSeries({ color: '#9333ea', lineWidth: 2.5 });
            line.setData(spreadData);
            if (this.stats.spreadStats && spreadData.length > 0) {
                const avgLine = this.charts.spreadDual.addLineSeries({ color: '#f59e0b', lineWidth: 2, priceLineVisible: false });
                avgLine.setData(spreadData.map(d => ({ time: d.time, value: this.stats.spreadStats.avg })));
                const p75Line = this.charts.spreadDual.addLineSeries({ color: '#10b981', lineWidth: 2, priceLineVisible: false });
                p75Line.setData(spreadData.map(d => ({ time: d.time, value: this.stats.spreadStats.p75 })));
                const minLine = this.charts.spreadDual.addLineSeries({ color: '#ef4444', lineWidth: 2, priceLineVisible: false });
                minLine.setData(spreadData.map(d => ({ time: d.time, value: this.stats.spreadStats.min })));
                const maxLine = this.charts.spreadDual.addLineSeries({ color: '#2563eb', lineWidth: 2, priceLineVisible: false });
                maxLine.setData(spreadData.map(d => ({ time: d.time, value: this.stats.spreadStats.max })));
            }
            this.makeResponsive(container, this.charts.spreadDual);
        },

        renderVolatilityChart(bcvFilled, binanceRates) {
            const container = document.getElementById('volatilityChart');
            if (!container) return;
            this.charts.volatility = LightweightCharts.createChart(container, {
                width: container.clientWidth, height: 320,
                layout: { background: { color: '#fff' }, textColor: '#333' },
                grid: { vertLines: { color: '#f0f0f0' }, horzLines: { color: '#f0f0f0' } },
                timeScale: { borderColor: '#ccc', timeVisible: true, secondsVisible: false },
                rightPriceScale: { borderColor: '#ccc' },
            });
            const changes = this.calculateDailyChanges(binanceRates, 'timestamp');
            if (changes.length > 0) {
                const series = this.charts.volatility.addHistogramSeries({ color: '#f97316' });
                series.setData(changes);
                const zeroLine = this.charts.volatility.addLineSeries({ color: '#94a3b8', lineWidth: 1, lineStyle: 2, priceLineVisible: false, lastValueVisible: false });
                zeroLine.setData(changes.map(d => ({ time: d.time, value: 0 })));
            }
            this.makeResponsive(container, this.charts.volatility);
        },

        renderDistributionChart(bcvFilled, binanceRates) {
            const container = document.getElementById('distributionChart');
            if (!container || bcvFilled.length === 0 || binanceRates.length === 0) return;
            this.charts.distribution = LightweightCharts.createChart(container, {
                width: container.clientWidth, height: 320,
                layout: { background: { color: '#fff' }, textColor: '#333' },
                grid: { vertLines: { color: '#f0f0f0' }, horzLines: { color: '#f0f0f0' } },
                timeScale: { visible: false },
                rightPriceScale: { borderColor: '#ccc' },
            });
            const bcvMap = new Map(bcvFilled.map(r => [r.timestamp, parseFloat(r.rate)]));
            const spreads = binanceRates.map(r => { const b = parseFloat(r.rate), c = bcvMap.get(r.timestamp); return c && b ? ((b - c) / b) * 100 : null; }).filter(v => v !== null);
            const bins = this.createHistogramBins(spreads, 20);
            const histData = bins.map((count, i) => ({ time: i, value: count, color: this.getColorForSpreadBin(i, bins.length) }));
            const series = this.charts.distribution.addHistogramSeries({});
            series.setData(histData);
            this.makeResponsive(container, this.charts.distribution);
        },

        prepareTimeSeriesData(data, field) {
            return data.map(r => ({ time: Math.floor(new Date(r[field]).getTime() / 1000), value: parseFloat(r.rate) }))
                .filter(d => !isNaN(d.time) && !isNaN(d.value)).sort((a, b) => a.time - b.time);
        },

        calculateDailyChanges(data, field) {
            const daily = new Map();
            data.forEach(r => { const d = r[field].split('T')[0]; if (!daily.has(d)) daily.set(d, []); daily.get(d).push(parseFloat(r.rate)); });
            const avgs = [];
            daily.forEach((rates, date) => avgs.push({ date, avg: rates.reduce((a, b) => a + b, 0) / rates.length }));
            const changes = [];
            for (let i = 1; i < avgs.length; i++) {
                const change = ((avgs[i].avg - avgs[i-1].avg) / avgs[i-1].avg) * 100;
                changes.push({ time: Math.floor(new Date(avgs[i].date).getTime() / 1000), value: change, color: change >= 0 ? '#10b981' : '#ef4444' });
            }
            return changes;
        },

        createHistogramBins(values, numBins) {
            const min = Math.min(...values), max = Math.max(...values), size = (max - min) / numBins;
            const bins = new Array(numBins).fill(0);
            values.forEach(v => { const i = Math.min(Math.floor((v - min) / size), numBins - 1); bins[i]++; });
            return bins;
        },

        getColorForSpreadBin(i, total) { const r = i / total; return r < 0.33 ? '#ef4444' : r < 0.66 ? '#f59e0b' : '#10b981'; },

        makeResponsive(container, chart) {
            new ResizeObserver(entries => { if (entries.length && chart) chart.applyOptions({ width: entries[0].contentRect.width }); }).observe(container);
        },

        formatRate(rate) { return rate ? rate.toFixed(2) + ' Bs' : '-'; },
        formatPercentage(p) { return p ? (p >= 0 ? '+' : '') + p.toFixed(2) + '%' : '-'; },
        formatDateTime(ts) { return ts ? new Date(ts).toLocaleString('es-VE', { timeZone: 'America/Caracas', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : '-'; },
        getSpreadIndicator() {
            if (!this.stats.spreadStats || !this.stats.spreadPercent) return 'low';
            const c = this.stats.spreadPercent;
            return c >= this.stats.spreadStats.p75 ? 'high' : c >= this.stats.spreadStats.avg ? 'medium' : 'low';
        }
    }
}
</script>
{% endblock %}
