<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tasas de Cambio VES/USD</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- TradingView Lightweight Charts -->
    <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>

    <!-- Alpine.js CDN -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

        * {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        .card {
            transition: all 0.2s ease;
        }

        .card:hover {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen py-6" x-data="chartApp()">
        <div class="max-w-7xl mx-auto px-4 sm:px-6">

            <!-- Header -->
            <div class="mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Tasas de Cambio VES/USD</h1>
                        <p class="text-sm text-gray-500 mt-1">Monitoreo en tiempo real</p>
                    </div>
                    <div class="text-right text-xs text-gray-500" x-show="startDate && endDate">
                        <div><span x-text="startDate"></span> — <span x-text="endDate"></span></div>
                        <div class="mt-0.5" x-show="bcvDataPoints || binanceDataPoints">
                            <span x-text="bcvDataPoints"></span> BCV · <span x-text="binanceDataPoints"></span> Binance
                        </div>
                    </div>
                </div>
            </div>

            <!-- Metrics Grid -->
            <div x-show="stats.bcv && stats.binance" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">

                <!-- BCV Rate -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 card">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-xs font-semibold text-gray-500 uppercase tracking-wide">BCV Oficial</span>
                        <div class="w-2 h-2 rounded-full bg-blue-500"></div>
                    </div>
                    <div class="text-3xl font-bold text-gray-900 mb-1" x-text="formatRate(stats.bcv?.current)"></div>
                    <div class="text-xs text-gray-500">Bs/USD</div>
                </div>

                <!-- Binance Rate -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 card">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Binance P2P</span>
                        <div class="w-2 h-2 rounded-full bg-orange-500"></div>
                    </div>
                    <div class="text-3xl font-bold text-gray-900 mb-1" x-text="formatRate(stats.binance?.current)"></div>
                    <div class="text-xs text-gray-500">Bs/USD</div>
                </div>

                <!-- Calculator Quick -->
                <div class="bg-gradient-to-br from-emerald-600 to-teal-600 rounded-lg shadow-sm p-4 card text-white">
                    <div class="text-xs font-semibold uppercase tracking-wide mb-3 opacity-90">Calculadora Bidireccional</div>
                    <div class="grid grid-cols-2 gap-3">
                        <!-- Campo BCV -->
                        <div>
                            <label class="text-[10px] opacity-75 mb-1 block uppercase tracking-wide">BCV</label>
                            <input
                                type="number"
                                x-model="bcvAmount"
                                @input="calculateFromBcv()"
                                placeholder="100"
                                class="w-full px-3 py-1.5 bg-white/20 border border-white/30 rounded text-sm font-semibold text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50"
                            >
                        </div>
                        <!-- Campo Binance -->
                        <div>
                            <label class="text-[10px] opacity-75 mb-1 block uppercase tracking-wide">Binance</label>
                            <input
                                type="number"
                                x-model="binanceAmount"
                                @input="calculateFromBinance()"
                                placeholder="100"
                                class="w-full px-3 py-1.5 bg-white/20 border border-white/30 rounded text-sm font-semibold text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50"
                            >
                        </div>
                    </div>
                    <div class="text-[10px] opacity-75 mt-2 text-center">USD equivalentes según tasas actuales</div>
                </div>

            </div>

            <!-- Spread Stats (Indicador Visual) -->
            <div x-show="stats.spreadStats" class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                <div class="mb-6">
                    <h3 class="text-sm font-bold text-gray-900">Indicador de Spread Actual</h3>
                    <p class="text-xs text-gray-500 mt-1">Spread actual comparado con bandas históricas (excluyendo datos de hoy). Las bandas representan el comportamiento normal del período anterior.</p>
                </div>

                <!-- Visual indicator bar with breakpoints -->
                <div class="relative px-2">
                    <!-- Current value marker (above bar) -->
                    <div class="relative h-8 mb-0.5">
                        <!-- Marcador del valor actual (indigo) -->
                        <div
                            class="absolute bottom-0 transform -translate-x-1/2 z-30"
                            :style="'left: ' + Math.min(100, Math.max(0, ((stats.spreadPercent - (stats.spreadStats?.min || 0)) / ((stats.spreadStats?.max || 100) - (stats.spreadStats?.min || 0))) * 100)) + '%'"
                        >
                            <div class="text-center">
                                <div class="text-xs font-bold text-indigo-700 leading-none mb-0.5" x-text="formatPercentage(stats.spreadPercent)"></div>
                                <div
                                    class="text-[8px] font-bold uppercase px-1 py-px rounded-full inline-block leading-none"
                                    :class="{
                                        'bg-green-100 text-green-700': getSpreadIndicator() === 'high',
                                        'bg-amber-100 text-amber-700': getSpreadIndicator() === 'medium',
                                        'bg-red-100 text-red-700': getSpreadIndicator() === 'low'
                                    }"
                                    x-text="getSpreadIndicator() === 'high' ? 'EXCELENTE' : getSpreadIndicator() === 'medium' ? 'BUENO' : 'BAJO'"
                                ></div>
                            </div>
                            <div class="w-px h-3 bg-indigo-600 mx-auto mt-0.5"></div>
                        </div>

                        <!-- Marcador del promedio histórico (amber) -->
                        <div
                            x-show="stats.spreadStats?.avg"
                            class="absolute bottom-0 transform -translate-x-1/2 z-20"
                            :style="'left: ' + Math.min(100, Math.max(0, ((stats.spreadStats?.avg - (stats.spreadStats?.min || 0)) / ((stats.spreadStats?.max || 100) - (stats.spreadStats?.min || 0))) * 100)) + '%'"
                        >
                            <div class="text-center">
                                <div class="text-xs font-bold text-amber-600 leading-none mb-0.5" x-text="formatPercentage(stats.spreadStats?.avg)"></div>
                                <div class="text-[8px] font-medium uppercase px-1 py-px bg-amber-50 text-amber-700 rounded-full inline-block leading-none">
                                    PROMEDIO
                                </div>
                            </div>
                            <div class="w-px h-3 bg-amber-500 mx-auto mt-0.5"></div>
                        </div>
                    </div>

                    <!-- Gradient bar -->
                    <div class="relative h-3 bg-gradient-to-r from-red-500 via-amber-500 via-lime-500 to-green-500 rounded-full shadow-sm">
                        <!-- Current position indicator -->
                        <div
                            class="absolute transform -translate-x-1/2 -translate-y-[3px] z-20"
                            :style="'left: ' + Math.min(100, Math.max(0, ((stats.spreadPercent - (stats.spreadStats?.min || 0)) / ((stats.spreadStats?.max || 100) - (stats.spreadStats?.min || 0))) * 100)) + '%'"
                        >
                            <!-- Outer glow ring -->
                            <div class="absolute inset-0 w-5 h-5 bg-indigo-400 rounded-full opacity-30 animate-ping"></div>
                            <!-- Main indicator -->
                            <div class="relative w-5 h-5 bg-gradient-to-br from-indigo-500 to-indigo-700 rounded-full shadow-lg border-2 border-white"></div>
                        </div>
                    </div>

                    <!-- Breakpoint markers (below bar) -->
                    <div class="relative h-10 mt-3">
                        <!-- MIN marker -->
                        <div class="absolute transform -translate-x-1/2" style="left: 0%">
                            <div class="w-px h-4 bg-red-400 mx-auto"></div>
                            <div class="text-center mt-1 min-w-max">
                                <div class="text-xs font-bold text-red-600" x-text="formatPercentage(stats.spreadStats?.min)"></div>
                                <div class="text-[10px] font-medium text-gray-400 uppercase">Bajo</div>
                            </div>
                        </div>

                        <!-- AVG marker -->
                        <div
                            class="absolute transform -translate-x-1/2"
                            :style="'left: ' + ((stats.spreadStats?.avg - stats.spreadStats?.min) / (stats.spreadStats?.max - stats.spreadStats?.min) * 100) + '%'"
                        >
                            <div class="w-px h-4 bg-amber-400 mx-auto"></div>
                            <div class="text-center mt-1 min-w-max">
                                <div class="text-xs font-bold text-amber-600" x-text="formatPercentage(stats.spreadStats?.avg)"></div>
                                <div class="text-[10px] font-medium text-gray-400 uppercase">Bueno</div>
                            </div>
                        </div>

                        <!-- P75 marker -->
                        <div
                            class="absolute transform -translate-x-1/2"
                            :style="'left: ' + ((stats.spreadStats?.p75 - stats.spreadStats?.min) / (stats.spreadStats?.max - stats.spreadStats?.min) * 100) + '%'"
                        >
                            <div class="w-px h-4 bg-lime-400 mx-auto"></div>
                            <div class="text-center mt-1 min-w-max">
                                <div class="text-xs font-bold text-lime-600" x-text="formatPercentage(stats.spreadStats?.p75)"></div>
                                <div class="text-[10px] font-medium text-gray-400 uppercase">Excelente</div>
                            </div>
                        </div>

                        <!-- MAX marker -->
                        <div class="absolute transform -translate-x-1/2" style="left: 100%">
                            <div class="w-px h-4 bg-green-400 mx-auto"></div>
                            <div class="text-center mt-1 min-w-max">
                                <div class="text-xs font-bold text-green-600" x-text="formatPercentage(stats.spreadStats?.max)"></div>
                                <div class="text-[10px] font-medium text-gray-400 uppercase">Máximo</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

                <!-- Chart 1: Tasas Comparativas con Área de Spread -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 lg:col-span-2">
                    <div class="px-5 py-4 border-b border-gray-200">
                        <div class="flex items-center justify-between mb-2">
                            <div>
                                <h2 class="text-base font-bold text-gray-900">Comparación de Tasas</h2>
                            </div>
                            <div class="flex items-center gap-4 text-xs font-medium">
                                <div class="flex items-center gap-1.5">
                                    <div class="w-3 h-0.5 bg-blue-600 rounded-full"></div>
                                    <span class="text-gray-600">BCV</span>
                                </div>
                                <div class="flex items-center gap-1.5">
                                    <div class="w-3 h-0.5 bg-orange-600 rounded-full"></div>
                                    <span class="text-gray-600">Binance</span>
                                </div>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 leading-relaxed">Líneas para BCV (azul) y Binance (naranja) con área sombreada verde entre ellas que representa visualmente el spread. Permite ver la brecha entre tasas de forma inmediata.</p>
                    </div>
                    <div class="p-5">
                        <div x-show="loading" class="flex justify-center items-center" style="height: 400px;">
                            <div class="text-center">
                                <div class="w-12 h-12 border-4 border-gray-200 border-t-indigo-600 rounded-full animate-spin mx-auto mb-3"></div>
                                <p class="text-sm text-gray-500">Cargando datos...</p>
                            </div>
                        </div>
                        <div x-show="!loading && error" class="flex justify-center items-center" style="height: 400px;">
                            <div class="text-center">
                                <svg class="w-16 h-16 mx-auto mb-3 text-red-500 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <p class="text-base font-semibold text-gray-900" x-text="error"></p>
                            </div>
                        </div>
                        <div x-show="!loading && !error">
                            <div id="ratesComparisonChart" class="w-full" style="height: 400px;"></div>
                        </div>
                    </div>
                </div>

                <!-- Chart 2: Spread Dual (Bs + %) -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                    <div class="px-5 py-4 border-b border-gray-200">
                        <div class="flex items-center justify-between mb-2">
                            <div>
                                <h2 class="text-base font-bold text-gray-900">Spread Absoluto y Relativo</h2>
                            </div>
                            <div class="flex items-center gap-3 text-xs font-medium">
                                <div class="flex items-center gap-1.5">
                                    <div class="w-3 h-2 bg-emerald-600 rounded"></div>
                                    <span class="text-gray-600">Bs</span>
                                </div>
                                <div class="flex items-center gap-1.5">
                                    <div class="w-3 h-0.5 bg-purple-600 rounded-full"></div>
                                    <span class="text-gray-600">%</span>
                                </div>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 leading-relaxed">Histograma verde muestra el spread en Bs (eje derecho) y línea púrpura el spread en % (eje izquierdo). Dual scale para ver ambas métricas simultáneamente.</p>
                    </div>
                    <div class="p-5">
                        <div x-show="loading" class="flex justify-center items-center" style="height: 320px;">
                            <div class="w-10 h-10 border-4 border-gray-200 border-t-indigo-600 rounded-full animate-spin"></div>
                        </div>
                        <div x-show="!loading && !error">
                            <div id="spreadDualChart" class="w-full" style="height: 320px;"></div>
                        </div>
                    </div>
                </div>

                <!-- Chart 3: Volatilidad Diaria -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                    <div class="px-5 py-4 border-b border-gray-200">
                        <div class="flex items-center justify-between mb-2">
                            <div>
                                <h2 class="text-base font-bold text-gray-900">Cambios Diarios (Volatilidad)</h2>
                            </div>
                            <div class="flex items-center gap-3 text-xs font-medium">
                                <div class="flex items-center gap-1.5">
                                    <div class="w-2 h-2 rounded-full bg-emerald-600"></div>
                                    <span class="text-gray-600">Aumentos</span>
                                </div>
                                <div class="flex items-center gap-1.5">
                                    <div class="w-2 h-2 rounded-full bg-red-600"></div>
                                    <span class="text-gray-600">Disminuciones</span>
                                </div>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 leading-relaxed">Muestra la variación porcentual día a día de Binance. Barras verdes indican aumentos, rojas disminuciones. Línea de referencia en 0%.</p>
                    </div>
                    <div class="p-5">
                        <div x-show="loading" class="flex justify-center items-center" style="height: 320px;">
                            <div class="w-10 h-10 border-4 border-gray-200 border-t-indigo-600 rounded-full animate-spin"></div>
                        </div>
                        <div x-show="!loading && !error">
                            <div id="volatilityChart" class="w-full" style="height: 320px;"></div>
                        </div>
                    </div>
                </div>

                <!-- Chart 4: Distribución de Spread -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                    <div class="px-5 py-4 border-b border-gray-200">
                        <div class="mb-2">
                            <h2 class="text-base font-bold text-gray-900">Distribución del Spread</h2>
                        </div>
                        <p class="text-xs text-gray-500 leading-relaxed">Histograma de frecuencias mostrando cómo se distribuye el spread %. Colores van de rojo (spreads bajos) a verde (spreads altos). Te ayuda a entender qué tan común es cada nivel de spread.</p>
                    </div>
                    <div class="p-5">
                        <div x-show="loading" class="flex justify-center items-center" style="height: 320px;">
                            <div class="w-10 h-10 border-4 border-gray-200 border-t-indigo-600 rounded-full animate-spin"></div>
                        </div>
                        <div x-show="!loading && !error">
                            <div id="distributionChart" class="w-full" style="height: 320px;"></div>
                        </div>
                    </div>
                </div>

                <!-- Chart 5: Evolución del Spread % con Bandas -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                    <div class="px-5 py-4 border-b border-gray-200">
                        <div class="flex items-center justify-between mb-2">
                            <div>
                                <h2 class="text-base font-bold text-gray-900">Spread % con Bandas Estadísticas</h2>
                            </div>
                            <div class="flex items-center gap-3 text-xs font-medium">
                                <div class="flex items-center gap-1.5">
                                    <div class="w-2 h-2 rounded-full bg-purple-600"></div>
                                    <span class="text-gray-600">Spread</span>
                                </div>
                                <div class="flex items-center gap-1.5">
                                    <div class="w-3 h-0.5 bg-amber-500 rounded-full"></div>
                                    <span class="text-gray-600">Media</span>
                                </div>
                                <div class="flex items-center gap-1.5">
                                    <div class="w-3 h-0.5 bg-emerald-600 rounded-full"></div>
                                    <span class="text-gray-600">P75</span>
                                </div>
                                <div class="flex items-center gap-1.5">
                                    <div class="w-3 h-0.5 bg-red-600 rounded-full"></div>
                                    <span class="text-gray-600">P25</span>
                                </div>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 leading-relaxed">Área púrpura muestra la evolución del spread %. Líneas de referencia calculadas excluyendo datos de hoy: naranja (media histórica), verde (percentil 75 - spread bueno), roja (percentil 25 - spread bajo). Compara el spread actual contra el comportamiento normal del período anterior.</p>
                    </div>
                    <div class="p-5">
                        <div x-show="loading" class="flex justify-center items-center" style="height: 320px;">
                            <div class="w-10 h-10 border-4 border-gray-200 border-t-indigo-600 rounded-full animate-spin"></div>
                        </div>
                        <div x-show="!loading && !error">
                            <div id="spreadBandsChart" class="w-full" style="height: 320px;"></div>
                        </div>
                    </div>
                </div>

            </div>

        </div>

    </div>

    <script>
        function chartApp() {
            return {
                days: 30,
                endDate: new Date().toISOString().split('T')[0],
                startDate: '',
                loading: false,
                error: null,
                charts: {
                    ratesComparison: null,
                    spreadDual: null,
                    volatility: null,
                    distribution: null,
                    spreadBands: null
                },
                stats: {
                    bcv: null,
                    binance: null,
                    spread: null,
                    spreadPercent: null,
                    spreadStats: null
                },
                bcvDataPoints: 0,
                binanceDataPoints: 0,
                bcvAmount: 100,
                binanceAmount: 0,

                init() {
                    this.fetchData();
                },

                calculateFromBcv() {
                    if (!this.stats.bcv || !this.stats.binance || !this.bcvAmount) {
                        this.binanceAmount = '';
                        return;
                    }

                    const usdBcv = parseFloat(this.bcvAmount) || 0;
                    // USD BCV → Bs (usando tasa BCV)
                    const bsTotal = usdBcv * this.stats.bcv.current;
                    // Bs → USD Binance (usando tasa Binance)
                    this.binanceAmount = (bsTotal / this.stats.binance.current).toFixed(2);
                },

                calculateFromBinance() {
                    if (!this.stats.bcv || !this.stats.binance || !this.binanceAmount) {
                        this.bcvAmount = '';
                        return;
                    }

                    const usdBinance = parseFloat(this.binanceAmount) || 0;
                    // USD Binance → Bs (usando tasa Binance)
                    const bsTotal = usdBinance * this.stats.binance.current;
                    // Bs → USD BCV (usando tasa BCV)
                    this.bcvAmount = (bsTotal / this.stats.bcv.current).toFixed(2);
                },

                async fetchData() {
                    this.loading = true;
                    this.error = null;

                    try {
                        const url = `/api/exchange-rates/bcv/?days=${this.days}&end_date=${this.endDate}`;
                        const response = await fetch(url);

                        if (!response.ok) {
                            throw new Error('Error al cargar los datos');
                        }

                        const data = await response.json();

                        this.startDate = data.start_date;
                        this.bcvDataPoints = data.bcv.length;
                        this.binanceDataPoints = data.binance_sell.length;

                        if (data.bcv.length === 0 && data.binance_sell.length === 0) {
                            this.error = 'No hay datos disponibles para este período';
                            this.loading = false;
                            return;
                        }


                        this.calculateStats(data.bcv, data.binance_sell);
                        this.calculateFromBcv();
                        this.renderAllCharts(data.bcv, data.binance_sell);

                    } catch (err) {
                        this.error = err.message;
                        console.error('Error:', err);
                    } finally {
                        this.loading = false;
                    }
                },

                calculateStats(bcvRates, binanceRates) {
                    // Determinar "hoy" (medianoche) para separar datos históricos
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const todayStr = today.toISOString().split('T')[0]; // YYYY-MM-DD

                    // Filtrar datos históricos (hasta ayer 23:59:59)
                    const bcvHistorical = bcvRates.filter(r => r.date < todayStr);
                    const binanceHistorical = binanceRates.filter(r => {
                        const date = r.timestamp.split('T')[0];
                        return date < todayStr;
                    });

                    // Stats BCV (usando TODOS los datos para mostrar valor actual)
                    if (bcvRates.length > 0) {
                        const bcvValues = bcvRates.map(r => r.rate);
                        this.stats.bcv = {
                            current: bcvValues[bcvValues.length - 1],
                            max: Math.max(...bcvValues),
                            min: Math.min(...bcvValues),
                            change: bcvValues[bcvValues.length - 1] - bcvValues[0]
                        };
                    }

                    // Stats Binance (usando TODOS los datos para mostrar valor actual)
                    if (binanceRates.length > 0) {
                        const binanceValues = binanceRates.map(r => r.rate);
                        this.stats.binance = {
                            current: binanceValues[binanceValues.length - 1],
                            max: Math.max(...binanceValues),
                            min: Math.min(...binanceValues),
                            change: binanceValues[binanceValues.length - 1] - binanceValues[0]
                        };
                    }

                    // Calcular spread actual (usando datos actuales)
                    if (this.stats.bcv && this.stats.binance) {
                        this.stats.spread = this.stats.binance.current - this.stats.bcv.current;
                        this.stats.spreadPercent = (this.stats.spread / this.stats.binance.current) * 100;
                    }

                    // Calcular estadísticas del spread HISTÓRICO (excluyendo hoy)
                    // Esto sirve como referencia estable para las bandas
                    if (bcvHistorical.length > 0 && binanceHistorical.length > 0) {
                        const bcvMap = new Map();
                        bcvHistorical.forEach(r => {
                            bcvMap.set(r.date, parseFloat(r.rate));
                        });

                        // Calcular spreads para todos los puntos históricos de Binance
                        const spreadPercents = [];
                        const spreadBs = [];

                        binanceHistorical.forEach(r => {
                            const date = r.timestamp.split('T')[0];
                            const bcvRate = bcvMap.get(date);
                            const binanceRate = parseFloat(r.rate);

                            if (bcvRate && !isNaN(binanceRate) && binanceRate > 0 && bcvRate > 0) {
                                const spreadPct = ((binanceRate - bcvRate) / binanceRate) * 100;
                                const spreadB = binanceRate - bcvRate;

                                if (!isNaN(spreadPct) && isFinite(spreadPct)) {
                                    spreadPercents.push(spreadPct);
                                    spreadBs.push(spreadB);
                                }
                            }
                        });

                        if (spreadPercents.length > 0) {
                            // Ordenar para calcular percentiles
                            const sortedPercents = [...spreadPercents].sort((a, b) => a - b);
                            const sortedBs = [...spreadBs].sort((a, b) => a - b);

                            const avg = spreadPercents.reduce((a, b) => a + b, 0) / spreadPercents.length;
                            const avgBs = spreadBs.reduce((a, b) => a + b, 0) / spreadBs.length;

                            // Calcular desviación estándar
                            const variance = spreadPercents.reduce((sum, val) => sum + Math.pow(val - avg, 2), 0) / spreadPercents.length;
                            const stdDev = Math.sqrt(variance);

                            // Calcular percentiles
                            const p25 = sortedPercents[Math.floor(sortedPercents.length * 0.25)];
                            const p50 = sortedPercents[Math.floor(sortedPercents.length * 0.50)];
                            const p75 = sortedPercents[Math.floor(sortedPercents.length * 0.75)];

                            this.stats.spreadStats = {
                                avg: avg,
                                avgBs: avgBs,
                                max: Math.max(...spreadPercents),
                                min: Math.min(...spreadPercents),
                                maxBs: Math.max(...spreadBs),
                                minBs: Math.min(...spreadBs),
                                stdDev: stdDev,
                                p25: p25,
                                p50: p50,
                                p75: p75,
                                spreadPercents: spreadPercents,
                                spreadBs: spreadBs
                            };
                        }
                    } else if (bcvRates.length > 0 && binanceRates.length > 0) {
                        // Fallback: Si no hay datos históricos suficientes, usar todos los datos
                        // Esto puede pasar si solo estamos viendo datos de hoy
                        const bcvMap = new Map();
                        bcvRates.forEach(r => {
                            bcvMap.set(r.date, parseFloat(r.rate));
                        });

                        const spreadPercents = [];
                        const spreadBs = [];

                        binanceRates.forEach(r => {
                            const date = r.timestamp.split('T')[0];
                            const bcvRate = bcvMap.get(date);
                            const binanceRate = parseFloat(r.rate);

                            if (bcvRate && !isNaN(binanceRate) && binanceRate > 0 && bcvRate > 0) {
                                const spreadPct = ((binanceRate - bcvRate) / binanceRate) * 100;
                                const spreadB = binanceRate - bcvRate;

                                if (!isNaN(spreadPct) && isFinite(spreadPct)) {
                                    spreadPercents.push(spreadPct);
                                    spreadBs.push(spreadB);
                                }
                            }
                        });

                        if (spreadPercents.length > 0) {
                            const sortedPercents = [...spreadPercents].sort((a, b) => a - b);
                            const sortedBs = [...spreadBs].sort((a, b) => a - b);

                            const avg = spreadPercents.reduce((a, b) => a + b, 0) / spreadPercents.length;
                            const avgBs = spreadBs.reduce((a, b) => a + b, 0) / spreadBs.length;

                            const variance = spreadPercents.reduce((sum, val) => sum + Math.pow(val - avg, 2), 0) / spreadPercents.length;
                            const stdDev = Math.sqrt(variance);

                            const p25 = sortedPercents[Math.floor(sortedPercents.length * 0.25)];
                            const p50 = sortedPercents[Math.floor(sortedPercents.length * 0.50)];
                            const p75 = sortedPercents[Math.floor(sortedPercents.length * 0.75)];

                            this.stats.spreadStats = {
                                avg: avg,
                                avgBs: avgBs,
                                max: Math.max(...spreadPercents),
                                min: Math.min(...spreadPercents),
                                maxBs: Math.max(...spreadBs),
                                minBs: Math.min(...spreadBs),
                                stdDev: stdDev,
                                p25: p25,
                                p50: p50,
                                p75: p75,
                                spreadPercents: spreadPercents,
                                spreadBs: spreadBs
                            };
                        }
                    }
                },

                fillBcvGaps(bcvRates, binanceRates) {
                    if (bcvRates.length === 0) return [];

                    // Si no hay datos de Binance, devolver BCV como está (con timestamps de medianoche)
                    if (binanceRates.length === 0) {
                        return bcvRates.map(r => ({
                            timestamp: r.date + 'T00:00:00Z',
                            rate: r.rate
                        }));
                    }

                    // Crear mapa de fechas BCV (solo fecha, sin hora)
                    const bcvMap = new Map();
                    bcvRates.forEach(r => {
                        const rate = parseFloat(r.rate);
                        if (!isNaN(rate) && isFinite(rate)) {
                            bcvMap.set(r.date, rate);
                        }
                    });

                    // Obtener todos los timestamps únicos de Binance
                    const binanceTimestamps = binanceRates.map(r => ({
                        timestamp: r.timestamp,
                        date: r.timestamp.split('T')[0]
                    }));

                    // Para cada timestamp de Binance, asignar el valor de BCV de ese día
                    const filled = [];
                    let lastKnownValue = null;

                    binanceTimestamps.forEach(item => {
                        const bcvValue = bcvMap.get(item.date);

                        // Si hay valor para ese día, usarlo; si no, usar el último conocido
                        if (bcvValue !== undefined) {
                            lastKnownValue = bcvValue;
                        }

                        if (lastKnownValue !== null) {
                            filled.push({
                                timestamp: item.timestamp,
                                rate: lastKnownValue
                            });
                        }
                    });

                    return filled;
                },

                renderAllCharts(bcvRates, binanceRates) {
                    if (typeof LightweightCharts === 'undefined') {
                        console.error('LightweightCharts no está disponible');
                        this.error = 'Error al cargar la biblioteca de gráficos';
                        return;
                    }

                    const bcvFilled = this.fillBcvGaps(bcvRates, binanceRates);

                    // Limpiar gráficos anteriores
                    Object.values(this.charts).forEach(chart => {
                        if (chart) chart.remove();
                    });

                    // Renderizar todos los gráficos
                    this.renderRatesComparisonChart(bcvFilled, binanceRates);
                    this.renderSpreadDualChart(bcvFilled, binanceRates);
                    this.renderVolatilityChart(bcvFilled, binanceRates);
                    this.renderDistributionChart(bcvFilled, binanceRates);
                    this.renderSpreadBandsChart(bcvFilled, binanceRates);
                },

                // Chart 1: Comparación de tasas con área de spread
                renderRatesComparisonChart(bcvFilled, binanceRates) {
                    const container = document.getElementById('ratesComparisonChart');
                    if (!container) return;

                    this.charts.ratesComparison = LightweightCharts.createChart(container, {
                        width: container.clientWidth,
                        height: 400,
                        layout: { background: { color: '#ffffff' }, textColor: '#333' },
                        grid: { vertLines: { color: '#f0f0f0' }, horzLines: { color: '#f0f0f0' } },
                        timeScale: { borderColor: '#cccccc', timeVisible: true, secondsVisible: false },
                        rightPriceScale: { borderColor: '#cccccc' },
                    });

                    // Serie Binance (línea naranja)
                    if (binanceRates.length > 0) {
                        const binanceSeries = this.charts.ratesComparison.addLineSeries({
                            color: '#f97316',
                            lineWidth: 2.5,
                            priceFormat: { type: 'price', precision: 2, minMove: 0.01 },
                        });
                        const binanceData = this.prepareTimeSeriesData(binanceRates, 'timestamp');
                        binanceSeries.setData(binanceData);
                    }

                    // Serie BCV (línea azul)
                    if (bcvFilled.length > 0) {
                        const bcvSeries = this.charts.ratesComparison.addLineSeries({
                            color: '#2563eb',
                            lineWidth: 2.5,
                            priceFormat: { type: 'price', precision: 2, minMove: 0.01 },
                        });
                        const bcvData = this.prepareTimeSeriesData(bcvFilled, 'timestamp');
                        bcvSeries.setData(bcvData);
                    }

                    // Área de spread (entre las dos líneas)
                    if (bcvFilled.length > 0 && binanceRates.length > 0) {
                        const spreadAreaSeries = this.charts.ratesComparison.addAreaSeries({
                            topColor: 'rgba(16, 185, 129, 0.3)',
                            bottomColor: 'rgba(16, 185, 129, 0.05)',
                            lineColor: 'rgba(16, 185, 129, 0.6)',
                            lineWidth: 1,
                            priceFormat: { type: 'price', precision: 2, minMove: 0.01 },
                        });

                        // Calcular el área entre las dos líneas
                        const bcvMap = new Map(bcvFilled.map(r => [r.timestamp, parseFloat(r.rate)]));
                        const spreadData = binanceRates
                            .map(r => {
                                const binanceRate = parseFloat(r.rate);
                                const bcvRate = bcvMap.get(r.timestamp);
                                if (!bcvRate || !binanceRate) return null;

                                return {
                                    time: Math.floor(new Date(r.timestamp).getTime() / 1000),
                                    value: bcvRate + (binanceRate - bcvRate) / 2 // Punto medio
                                };
                            })
                            .filter(d => d !== null)
                            .sort((a, b) => a.time - b.time);

                        spreadAreaSeries.setData(spreadData);
                    }

                    this.makeResponsive(container, this.charts.ratesComparison);
                },

                // Chart 2: Spread Dual (Bs + %)
                renderSpreadDualChart(bcvFilled, binanceRates) {
                    const container = document.getElementById('spreadDualChart');
                    if (!container || bcvFilled.length === 0 || binanceRates.length === 0) return;

                    this.charts.spreadDual = LightweightCharts.createChart(container, {
                        width: container.clientWidth,
                        height: 320,
                        layout: { background: { color: '#ffffff' }, textColor: '#333' },
                        grid: { vertLines: { color: '#f0f0f0' }, horzLines: { color: '#f0f0f0' } },
                        timeScale: { borderColor: '#cccccc', timeVisible: true, secondsVisible: false },
                        rightPriceScale: { borderColor: '#cccccc' },
                        leftPriceScale: { visible: true, borderColor: '#9333ea' },
                    });

                    const bcvMap = new Map(bcvFilled.map(r => [r.timestamp, parseFloat(r.rate)]));

                    // Spread en Bs (histograma - escala derecha)
                    const spreadBsData = [];
                    const spreadPercentData = [];

                    binanceRates.forEach(r => {
                        const binanceRate = parseFloat(r.rate);
                        const bcvRate = bcvMap.get(r.timestamp);
                        if (!bcvRate || !binanceRate) return;

                        const time = Math.floor(new Date(r.timestamp).getTime() / 1000);
                        const spreadBs = binanceRate - bcvRate;
                        const spreadPercent = (spreadBs / binanceRate) * 100;

                        spreadBsData.push({ time, value: spreadBs, color: '#10b981' });
                        spreadPercentData.push({ time, value: spreadPercent });
                    });

                    // Histograma Bs (derecha)
                    const histogramSeries = this.charts.spreadDual.addHistogramSeries({
                        color: '#10b981',
                        priceFormat: { type: 'price', precision: 2, minMove: 0.01 },
                        priceScaleId: 'right',
                    });
                    histogramSeries.setData(spreadBsData);

                    // Línea % (izquierda)
                    const lineSeries = this.charts.spreadDual.addLineSeries({
                        color: '#9333ea',
                        lineWidth: 2,
                        priceFormat: { type: 'price', precision: 2, minMove: 0.01 },
                        priceScaleId: 'left',
                    });
                    lineSeries.setData(spreadPercentData);

                    this.makeResponsive(container, this.charts.spreadDual);
                },

                // Chart 3: Volatilidad (cambios diarios)
                renderVolatilityChart(bcvFilled, binanceRates) {
                    const container = document.getElementById('volatilityChart');
                    if (!container) return;

                    this.charts.volatility = LightweightCharts.createChart(container, {
                        width: container.clientWidth,
                        height: 320,
                        layout: { background: { color: '#ffffff' }, textColor: '#333' },
                        grid: { vertLines: { color: '#f0f0f0' }, horzLines: { color: '#f0f0f0' } },
                        timeScale: { borderColor: '#cccccc', timeVisible: true, secondsVisible: false },
                        rightPriceScale: { borderColor: '#cccccc' },
                    });

                    // Calcular cambios diarios para Binance
                    const binanceChanges = this.calculateDailyChanges(binanceRates, 'timestamp');
                    if (binanceChanges.length > 0) {
                        const binanceSeries = this.charts.volatility.addHistogramSeries({
                            color: '#f97316',
                            priceFormat: { type: 'price', precision: 2, minMove: 0.01 },
                        });
                        binanceSeries.setData(binanceChanges);
                    }

                    // Línea en 0 para referencia
                    if (binanceChanges.length > 0) {
                        const zeroLine = this.charts.volatility.addLineSeries({
                            color: '#94a3b8',
                            lineWidth: 1,
                            lineStyle: LightweightCharts.LineStyle.Dashed,
                            priceLineVisible: false,
                            lastValueVisible: false,
                        });
                        zeroLine.setData(binanceChanges.map(d => ({ time: d.time, value: 0 })));
                    }

                    this.makeResponsive(container, this.charts.volatility);
                },

                // Chart 4: Distribución de spread
                renderDistributionChart(bcvFilled, binanceRates) {
                    const container = document.getElementById('distributionChart');
                    if (!container || bcvFilled.length === 0 || binanceRates.length === 0) return;

                    this.charts.distribution = LightweightCharts.createChart(container, {
                        width: container.clientWidth,
                        height: 320,
                        layout: { background: { color: '#ffffff' }, textColor: '#333' },
                        grid: { vertLines: { color: '#f0f0f0' }, horzLines: { color: '#f0f0f0' } },
                        timeScale: { visible: false },
                        rightPriceScale: { borderColor: '#cccccc' },
                    });

                    // Calcular spread %
                    const bcvMap = new Map(bcvFilled.map(r => [r.timestamp, parseFloat(r.rate)]));
                    const spreadPercents = binanceRates
                        .map(r => {
                            const binanceRate = parseFloat(r.rate);
                            const bcvRate = bcvMap.get(r.timestamp);
                            if (!bcvRate || !binanceRate) return null;
                            return ((binanceRate - bcvRate) / binanceRate) * 100;
                        })
                        .filter(v => v !== null);

                    // Crear histograma de distribución
                    const bins = this.createHistogramBins(spreadPercents, 20);
                    const histogramData = bins.map((count, i) => ({
                        time: i,
                        value: count,
                        color: this.getColorForSpreadBin(i, bins.length)
                    }));

                    const histogramSeries = this.charts.distribution.addHistogramSeries({
                        priceFormat: { type: 'price', precision: 0, minMove: 1 },
                    });
                    histogramSeries.setData(histogramData);

                    this.makeResponsive(container, this.charts.distribution);
                },

                // Chart 5: Spread % con bandas estadísticas
                renderSpreadBandsChart(bcvFilled, binanceRates) {
                    const container = document.getElementById('spreadBandsChart');
                    if (!container || bcvFilled.length === 0 || binanceRates.length === 0) return;

                    this.charts.spreadBands = LightweightCharts.createChart(container, {
                        width: container.clientWidth,
                        height: 320,
                        layout: { background: { color: '#ffffff' }, textColor: '#333' },
                        grid: { vertLines: { color: '#f0f0f0' }, horzLines: { color: '#f0f0f0' } },
                        timeScale: { borderColor: '#cccccc', timeVisible: true, secondsVisible: false },
                        rightPriceScale: { borderColor: '#cccccc' },
                    });

                    const bcvMap = new Map(bcvFilled.map(r => [r.timestamp, parseFloat(r.rate)]));
                    const spreadData = [];

                    binanceRates.forEach(r => {
                        const binanceRate = parseFloat(r.rate);
                        const bcvRate = bcvMap.get(r.timestamp);
                        if (!bcvRate || !binanceRate) return;

                        const time = Math.floor(new Date(r.timestamp).getTime() / 1000);
                        const spreadPercent = ((binanceRate - bcvRate) / binanceRate) * 100;
                        spreadData.push({ time, value: spreadPercent });
                    });

                    // Serie principal de spread
                    const spreadSeries = this.charts.spreadBands.addAreaSeries({
                        topColor: 'rgba(147, 51, 234, 0.3)',
                        bottomColor: 'rgba(147, 51, 234, 0.05)',
                        lineColor: '#9333ea',
                        lineWidth: 2,
                        priceFormat: { type: 'price', precision: 2, minMove: 0.01 },
                    });
                    spreadSeries.setData(spreadData);

                    // Líneas de referencia
                    if (this.stats.spreadStats && spreadData.length > 0) {
                        // Media
                        const avgLine = this.charts.spreadBands.addLineSeries({
                            color: '#f59e0b',
                            lineWidth: 2,
                            lineStyle: LightweightCharts.LineStyle.Dashed,
                            priceLineVisible: false,
                        });
                        avgLine.setData(spreadData.map(d => ({ time: d.time, value: this.stats.spreadStats.avg })));

                        // P75
                        const p75Line = this.charts.spreadBands.addLineSeries({
                            color: '#10b981',
                            lineWidth: 1.5,
                            lineStyle: LightweightCharts.LineStyle.Dashed,
                            priceLineVisible: false,
                        });
                        p75Line.setData(spreadData.map(d => ({ time: d.time, value: this.stats.spreadStats.p75 })));

                        // P25
                        const p25Line = this.charts.spreadBands.addLineSeries({
                            color: '#ef4444',
                            lineWidth: 1.5,
                            lineStyle: LightweightCharts.LineStyle.Dashed,
                            priceLineVisible: false,
                        });
                        p25Line.setData(spreadData.map(d => ({ time: d.time, value: this.stats.spreadStats.p25 })));
                    }

                    this.makeResponsive(container, this.charts.spreadBands);
                },

                // Funciones auxiliares
                prepareTimeSeriesData(data, timeField) {
                    return data
                        .map(r => ({
                            time: Math.floor(new Date(r[timeField]).getTime() / 1000),
                            value: parseFloat(r.rate)
                        }))
                        .filter(d => !isNaN(d.time) && !isNaN(d.value) && isFinite(d.value))
                        .sort((a, b) => a.time - b.time);
                },

                calculateDailyChanges(data, timeField) {
                    const changes = [];
                    const dailyData = new Map();

                    // Agrupar por día
                    data.forEach(r => {
                        const date = r[timeField].split('T')[0];
                        const rate = parseFloat(r.rate);
                        if (!dailyData.has(date)) {
                            dailyData.set(date, []);
                        }
                        dailyData.get(date).push(rate);
                    });

                    // Calcular promedio diario
                    const dailyAverages = [];
                    dailyData.forEach((rates, date) => {
                        const avg = rates.reduce((a, b) => a + b, 0) / rates.length;
                        dailyAverages.push({ date, avg });
                    });

                    // Calcular cambios porcentuales
                    for (let i = 1; i < dailyAverages.length; i++) {
                        const prev = dailyAverages[i - 1].avg;
                        const curr = dailyAverages[i].avg;
                        const change = ((curr - prev) / prev) * 100;
                        const color = change >= 0 ? '#10b981' : '#ef4444';

                        changes.push({
                            time: Math.floor(new Date(dailyAverages[i].date).getTime() / 1000),
                            value: change,
                            color: color
                        });
                    }

                    return changes;
                },

                createHistogramBins(values, numBins) {
                    const min = Math.min(...values);
                    const max = Math.max(...values);
                    const binSize = (max - min) / numBins;
                    const bins = new Array(numBins).fill(0);

                    values.forEach(v => {
                        const binIndex = Math.min(Math.floor((v - min) / binSize), numBins - 1);
                        bins[binIndex]++;
                    });

                    return bins;
                },

                getColorForSpreadBin(binIndex, totalBins) {
                    const ratio = binIndex / totalBins;
                    if (ratio < 0.33) return '#ef4444';
                    if (ratio < 0.66) return '#f59e0b';
                    return '#10b981';
                },

                makeResponsive(container, chart) {
                    new ResizeObserver(entries => {
                        if (entries.length === 0 || !chart) return;
                        chart.applyOptions({ width: entries[0].contentRect.width });
                    }).observe(container);
                },

                formatDate(dateStr) {
                    const date = new Date(dateStr + 'T00:00:00');
                    return date.toLocaleDateString('es-VE', {
                        month: 'short',
                        day: 'numeric'
                    });
                },

                formatRate(rate) {
                    if (!rate) return '-';
                    return rate.toFixed(2) + ' Bs';
                },

                formatChange(change) {
                    if (!change) return '-';
                    const sign = change >= 0 ? '+' : '';
                    return sign + change.toFixed(4) + ' Bs';
                },

                formatPercentage(percent) {
                    if (!percent) return '-';
                    const sign = percent >= 0 ? '+' : '';
                    return sign + percent.toFixed(2) + '%';
                },

                getSpreadIndicator() {
                    if (!this.stats.spreadStats || !this.stats.spreadPercent) return 'low';

                    const current = this.stats.spreadPercent;
                    const avg = this.stats.spreadStats.avg;
                    const p75 = this.stats.spreadStats.p75;

                    if (current >= p75) return 'high';
                    if (current >= avg) return 'medium';
                    return 'low';
                }
            }
        }
    </script>
</body>
</html>
